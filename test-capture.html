<!doctype html>
<meta charset=utf-8>
<title>Test Capture</title>
<style>
html {
  display: table;
  width: 100%;
  height: 100%;
  font: 24px Helvetica, sans-serif;
}
body {
  display: table-cell;
  vertical-align: middle;
  text-align: center;
}
</style>

<body>
<script>

var P = {};

P.args = {};
location.search.slice(1).split('&').forEach(function(p) {
  var s = p.split('=');
  if (s[0]) P.args[s[0]] = s[1] || '';
});

P.data = [];
P.id = +P.args.id;
P.maxFrames = +P.args.max;
P.frameCount = 0;

P.stop = false;

P.done = function() {
  if (P.stop || !P.data.length) return;
  P.data.push({done: true});
  P.stop = true;
  P.submit();
};

P.submit = function() {
  var xhr = new XMLHttpRequest;
  xhr.open('POST', '/test-add', true);
  xhr.send(JSON.stringify({
    projectID: P.id,
    maxFrames: P.maxFrames,
    data: P.data
  }));
  xhr.onload = function() {
    document.body.innerHTML = 'You can close the tab now.';
  };
};

P.captureOp = function(obj, op, args) {
  if (P.stop) return;
  P.data.push({obj: obj, op: op, args: args});
};

P.captureState = function(state) {
  if (P.stop) return;
  P.data.push({state: JSON.parse(state)});
  if (P.maxFrames && ++P.frameCount === P.maxFrames) {
    P.stop = true;
    P.submit();
  }
};

function JSthrowError(e) {
  console.error(e);
}

document.body.innerHTML = [
  '<object type=application/x-shockwave-flash data=test-capture.swf width=482 height=425>',
  '<param name=movie value=test-capture.swf>',
  '<param name=allowscriptaccess value=always>',
  '<param name=FlashVars value="' + [
    'phosphorusDoneFn=P.done',
    'phosphorusOpFn=P.captureOp',
    'phosphorusStateFn=P.captureState',
    'autostart=true',
    'inIE=false',
    'project=http://getsb2.herokuapp.com/' + P.id
  ].join('&amp;') + '">',
  '</object>'
].join('');

</script>
